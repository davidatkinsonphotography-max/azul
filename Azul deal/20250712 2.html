<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tile Choosing App</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 1920px;
      height: 1080px;
      background: url('backgroundcircles.jpg') no-repeat center center;
      background-size: cover;
      font-family: sans-serif;
      overflow: hidden;
    }

    .disk {
      position: absolute;
      width: 293px;
      height: 293px;
      background: url('disk.png') no-repeat center;
      background-size: contain;
  visibility: hidden;
    }


.excessbox {
  width: 110px;
  height: 110px;
  object-fit: contain;
}

#excess-area {
  position: absolute;
  left: 576px;
  top: 219px;
  width: 770px;
  height: 440px;
  display: grid;
  grid-template-columns: repeat(7, 110px);
  grid-template-rows: repeat(4, 110px);
  gap: 0;
}

    .tile {
      position: absolute;
      width: 110px;
      height: 110px;
      background-size: cover;
      cursor: pointer;
    }

    #start-game-btn, #next-round-btn {
      position: absolute;
      width: 300px;
      height: 114px;
      cursor: pointer;
    }

    #start-game-btn {
      left: 1591px;
      top: 49px;
    }

    #next-round-btn {
      left: 810px;
      top: 49px;
    }
  </style>
</head>
<body>
  <!-- Disks -->
<img class="disk" id="disk1" src="disk.png" style="left:34px; top:219px;">
<img class="disk" id="disk2" src="disk.png" style="left:34px; top:547px;">
<img class="disk" id="disk3" src="disk.png" style="left:322px; top:760px;">
<img class="disk" id="disk4" src="disk.png" style="left:650px; top:760px;">
<img class="disk" id="disk5" src="disk.png" style="left:978px; top:760px;">
<img class="disk" id="disk6" src="disk.png" style="left:1306px; top:760px;">
<img class="disk" id="disk7" src="disk.png" style="left:1593px; top:547px;">
<img class="disk" id="disk8" src="disk.png" style="left:1593px; top:219px;">

<!-- Excess Tile Drop Zone -->
<div id="excess-area">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
  <img class="excessbox" src="excessbox.png">
</div>

  <!-- Buttons -->
  <img id="start-game-btn" src="startgameup.png" 
       onmousedown="this.src='startgamedown.png'" 
       onmouseup="this.src='startgameup.png'">

  <img id="next-round-btn" src="nextroundup.png" 
       onmousedown="this.src='nextrounddown.png'" 
       onmouseup="this.src='nextroundup.png'">

<script>
const disks = [
  document.getElementById('disk1'),
  document.getElementById('disk2'),
  document.getElementById('disk3'),
  document.getElementById('disk4'),
  document.getElementById('disk5'),
  document.getElementById('disk6'),
  document.getElementById('disk7'),
  document.getElementById('disk8'),
];

const finalPositions = disks.map(disk => ({
  left: parseInt(disk.style.left, 10),
  top: parseInt(disk.style.top, 10),
}));

function resetDisksToCenter() {
  const centerX = 1920 / 2 - 293 / 2;
  const startY = 0;
  disks.forEach(disk => {
    disk.style.transition = 'none';
    disk.style.left = centerX + 'px';
    disk.style.top = startY + 'px';
    disk.style.zIndex = 1000;
  });
}

function dealDisks() {
  disks.forEach(disk => {
    disk.style.visibility = 'visible';
  });
  resetDisksToCenter();
  disks.forEach((disk, i) => {
    setTimeout(() => {
      disk.style.transition = 'left 0.4s ease, top 0.4s ease';
      disk.style.left = finalPositions[i].left + 'px';
      disk.style.top = finalPositions[i].top + 'px';
      disk.style.zIndex = 10 + i;
    }, i * 200);
  });
}

const TILE_COLORS = ['aqua', 'red', 'black', 'blue', 'orange'];
const TILE_IMAGES = {
  aqua: 'aquatile.png',
  red: 'redtile.png',
  black: 'blacktile.png',
  blue: 'bluetile.png',
  orange: 'orangetile.png',
};

const maxTilesPerColor = 20;
const tilesPerDisk = 4;

const diskElements = disks;
const diskTiles = [];
const excessBoxes = Array.from(document.querySelectorAll('.excessbox'));

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function dealTilesToDisks() {
  diskTiles.forEach(dts => dts.forEach(t => t.tile.remove()));
  diskTiles.length = 0;

  const centerX = 1920 / 2 - 110 / 2;
  const startY = 0;

  diskElements.forEach((disk, diskIndex) => {
    const tilesForDisk = [];
    const usedColorCount = {};

    for (let i = 0; i < tilesPerDisk; i++) {
      let color;
      do {
        color = TILE_COLORS[getRandomInt(0, TILE_COLORS.length - 1)];
        usedColorCount[color] = (usedColorCount[color] || 0) + 1;
      } while (usedColorCount[color] > maxTilesPerColor);

      const tile = document.createElement('img');
      tile.src = TILE_IMAGES[color];
      tile.className = 'tile';
      tile.dataset.color = color;
      tile.dataset.diskIndex = diskIndex;
      tile.dataset.selected = 'false';
      tile.style.position = 'absolute';
      tile.style.width = '110px';
      tile.style.height = '110px';
      tile.style.cursor = 'pointer';
      tile.style.zIndex = 1100;
      tile.style.left = centerX + 'px';
      tile.style.top = startY + 'px';
      tile.style.opacity = '0';
      tile.style.transition = 'none';
      tile.style.transform = 'rotate(0deg)';

      const positions = [
        { left: 40, top: 40 },
        { left: 143, top: 40 },
        { left: 40, top: 143 },
        { left: 143, top: 143 },
      ];
      const pos = positions[i];
      const finalLeft = disk.offsetLeft + pos.left;
      const finalTop = disk.offsetTop + pos.top;

      tile.dataset.finalLeft = finalLeft;
      tile.dataset.finalTop = finalTop;

      tile.addEventListener('click', () => {
        if (tile.dataset.selected === 'true') return;

        const clickedColor = tile.dataset.color;
        const diskIdx = parseInt(tile.dataset.diskIndex, 10);
        const sameColorTiles = diskTiles[diskIdx].filter(
          t => t.tile.dataset.color === clickedColor && t.tile.dataset.selected !== 'true'
        );

        sameColorTiles.forEach(t => (t.tile.dataset.selected = 'true'));

        sameColorTiles.forEach((t, i) => {
          setTimeout(() => {
            t.tile.style.transition = 'top 0.8s ease, opacity 0.8s ease';
            t.tile.style.top = window.innerHeight + 150 + 'px';
            t.tile.style.opacity = '0';
          }, i * 150);
        });

        setTimeout(() => {
          moveWasteTiles(diskIdx);
        }, sameColorTiles.length * 150 + 800);
      });

      document.body.appendChild(tile);
      tilesForDisk.push({ tile, finalLeft, finalTop });
    }
    diskTiles.push(tilesForDisk);
  });
}

function animateTilesToDisks(callback) {
  let allTiles = diskTiles.flat();
  allTiles.forEach(({ tile }) => {
    tile.style.opacity = '0';
    tile.style.left = (1920 / 2 - 110 / 2) + 'px';
    tile.style.top = '0px';
    tile.style.transform = 'rotate(0deg)';
    tile.style.transition = 'none';
  });

  allTiles.forEach(({ tile, finalLeft, finalTop }, i) => {
    setTimeout(() => {
      tile.style.transition = 'left 0.5s ease, top 0.5s ease, opacity 0.5s ease, transform 0.5s ease';
      tile.style.left = finalLeft + 'px';
      tile.style.top = finalTop + 'px';
      tile.style.opacity = '1';
      tile.style.transform = `rotate(${getRandomInt(-15, 15)}deg)`;
      if (i === allTiles.length - 1 && callback) {
        setTimeout(callback, 600);
      }
    }, i * 150);
  });
}

function moveWasteTiles(diskIndex) {
  const wasteTiles = diskTiles[diskIndex].filter(t => t.tile.dataset.selected !== 'true');

  let excessIndex = 0;
  wasteTiles.forEach((waste, i) => {
    while (
      excessIndex < excessBoxes.length &&
      excessBoxes[excessIndex].dataset.occupied === 'true'
    ) {
      excessIndex++;
    }
    if (excessIndex >= excessBoxes.length) return;

    const box = excessBoxes[excessIndex];
    box.dataset.occupied = 'true';
    excessIndex++;

    const boxRect = box.getBoundingClientRect();
    const bodyRect = document.body.getBoundingClientRect();

    const targetLeft = boxRect.left - bodyRect.left;
    const targetTop = boxRect.top - bodyRect.top;

    setTimeout(() => {
      waste.tile.style.transition = 'left 0.5s ease, top 0.5s ease, opacity 0.5s ease, transform 0.5s ease';
      waste.tile.style.left = targetLeft + 'px';
      waste.tile.style.top = targetTop + 'px';
      waste.tile.style.opacity = '1';
      waste.tile.style.transform = 'rotate(0deg)';
    }, i * 300);
  });
}

// EXCESS TILE FUNCTIONS
let excessTilesUnsorted = [];
let excessTiles = [];
let oneTilePenalty = null;
let oneTileUsed = false;

function layoutExcessTiles(animated = true) {
  const sortedTiles = [...excessTilesUnsorted].sort((a, b) =>
    a.dataset.color.localeCompare(b.dataset.color)
  );

  const excessArea = document.getElementById('excess-area');
  const gridCols = 7;
  const tileSize = 110;

  sortedTiles.forEach((tile, index) => {
    const col = index % gridCols;
    const row = Math.floor(index / gridCols);
    const left = excessArea.offsetLeft + col * tileSize;
    const top = excessArea.offsetTop + row * tileSize;

    tile.style.transition = animated ? 'left 0.5s ease, top 0.5s ease' : 'none';

    requestAnimationFrame(() => {
      tile.style.left = left + 'px';
      tile.style.top = top + 'px';
    });
  });

  excessTiles = sortedTiles;
}

function addToExcess(tilesToAdd, callback) {
  tilesToAdd.forEach(tile => {
    tile.style.transition = 'none';
    tile.style.position = 'absolute';
    tile.style.zIndex = 1200;
    tile.style.opacity = '1';

    if (!excessTilesUnsorted.includes(tile)) {
      excessTilesUnsorted.push(tile);
    }

    tile.addEventListener('click', onExcessTileClick);
    document.body.appendChild(tile);
  });

  requestAnimationFrame(() => layoutExcessTiles(true));
  if (callback) callback();
}

function removeColorFromExcess(color, callback) {
  const toRemove = excessTilesUnsorted.filter(tile => tile.dataset.color === color);
  excessTilesUnsorted = excessTilesUnsorted.filter(tile => tile.dataset.color !== color);

  toRemove.forEach(tile => {
    tile.removeEventListener('click', onExcessTileClick);
  });

  if (!oneTileUsed && oneTilePenalty) {
    oneTileUsed = true;
    const tile = oneTilePenalty;
    tile.style.transition = 'transform 0.4s ease';
    tile.style.transformOrigin = 'center';
    tile.style.transform = 'scale(2.5)';
    tile.style.left = (window.innerWidth / 2 - 55) + 'px';
    tile.style.top = (window.innerHeight / 2 - 55) + 'px';

    setTimeout(() => {
      tile.style.transition = 'top 0.8s ease, opacity 0.8s ease';
      tile.style.top = window.innerHeight + 150 + 'px';
      tile.style.opacity = '0';
      setTimeout(() => tile.remove(), 850);
    }, 1000);
  }

  toRemove.forEach((tile, i) => {
    setTimeout(() => {
      tile.style.transition = 'top 0.8s ease, opacity 0.8s ease';
      tile.style.top = window.innerHeight + 150 + 'px';
      tile.style.opacity = '0';
      setTimeout(() => {
        tile.remove();
        if (i === toRemove.length - 1 && callback) callback();
      }, 850);
    }, i * 150);
  });

  setTimeout(() => layoutExcessTiles(true), toRemove.length * 150 + 900);
}

function onExcessTileClick(e) {
  const clickedTile = e.currentTarget;
  const clickedColor = clickedTile.dataset.color;
  removeColorFromExcess(clickedColor);
}

function dealPenaltyTile() {
  const box = document.getElementById('penalty-box');
  if (!box) return;

  const tile = document.createElement('img');
  tile.src = 'onetile.png';
  tile.className = 'tile';
  tile.dataset.color = 'penalty';
  tile.style.position = 'absolute';
  tile.style.width = '110px';
  tile.style.height = '110px';
  tile.style.opacity = '0';
  tile.style.transition = 'none';
  tile.style.zIndex = '1200';

  document.body.appendChild(tile);

  const boxRect = box.getBoundingClientRect();
  const bodyRect = document.body.getBoundingClientRect();
  const targetLeft = boxRect.left - bodyRect.left;
  const targetTop = boxRect.top - bodyRect.top;

  tile.style.left = (1920 / 2 - 55) + 'px';
  tile.style.top = '0px';

  setTimeout(() => {
    tile.style.transition = 'left 0.5s ease, top 0.5s ease, opacity 0.5s ease';
    tile.style.left = targetLeft + 'px';
    tile.style.top = targetTop + 'px';
    tile.style.opacity = '1';
  }, 500);

  oneTilePenalty = tile;
}

// FINAL DOMContentLoaded: hook buttons and initialize penalty box
document.addEventListener('DOMContentLoaded', () => {
  const gameBtn = document.getElementById('start-game-btn');
  const nextRoundBtn = document.getElementById('next-round-btn');

  const existingPenaltyBox = document.getElementById('penalty-box');
  if (!existingPenaltyBox) {
    const penaltyBox = document.createElement('img');
    penaltyBox.id = 'penalty-box';
    penaltyBox.src = 'excessbox.png';
    penaltyBox.className = 'excessbox';
    penaltyBox.style.position = 'absolute';
    penaltyBox.style.left = '450px';
    penaltyBox.style.top = '385px';
    document.body.appendChild(penaltyBox);
  }

  gameBtn.addEventListener('click', () => {
    diskTiles.forEach(disk => disk.forEach(tileObj => tileObj.tile.remove()));
    diskTiles.length = 0;
    excessTilesUnsorted.forEach(tile => tile.remove());
    excessTilesUnsorted = [];
    excessTiles = [];
    oneTilePenalty?.remove();
    oneTilePenalty = null;
    oneTileUsed = false;

    dealDisks();
    setTimeout(() => {
      dealTilesToDisks();
      animateTilesToDisks();
      dealPenaltyTile();
    }, disks.length * 200 + 400);
  });

  nextRoundBtn.addEventListener('click', () => {
    dealTilesToDisks();
    animateTilesToDisks();
  });
});
</script>

</body>
</html>